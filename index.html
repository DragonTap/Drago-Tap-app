<script>
  let dragoCount = parseInt(localStorage.getItem('dragoCount')) || 0;
  let level = parseInt(localStorage.getItem('level')) || 1;
  const levelCost = 50;

  let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
  let playerName = localStorage.getItem('playerName') || null;

  const tg = window.Telegram.WebApp;
  tg.ready();

  if (!playerName) {
    if (tg.initDataUnsafe?.user) {
      playerName = tg.initDataUnsafe.user.first_name || 'Игрок';
      localStorage.setItem('playerName', playerName);
      if (tg.initDataUnsafe.user.username === 'ADMIN1') {
        document.getElementById('admin-section').style.display = 'block';
      }
    } else {
      playerName = 'Игрок';
    }
  } else if (playerName === 'ADMIN1') {
    document.getElementById('admin-section').style.display = 'block';
  }

  const drago = document.getElementById('drago');
  const counter = document.getElementById('counter');
  const levelDisplay = document.getElementById('level');
  const shopButton = document.getElementById('shop');
  const bonusButton = document.getElementById('bonus-btn');
  const ratingButton = document.getElementById('rating-btn');
  const clearDataButton = document.getElementById('clear-data-btn');

  const updateUI = () => {
    counter.textContent = `Вы заработали: ${dragoCount} Drago`;
    levelDisplay.textContent = `Уровень: ${level}`;
    shopButton.textContent = `Улучшить уровень (Стоимость: ${levelCost * level} Drago)`;
  };

  const saveGameData = () => {
    localStorage.setItem('dragoCount', dragoCount);
    localStorage.setItem('level', level);
  };

  updateUI();

  const lastBonus = localStorage.getItem('lastBonus') || 0;
  const ONE_DAY = 24 * 60 * 60 * 1000;

  const checkBonus = () => {
    const now = new Date().getTime();
    if (now - lastBonus > ONE_DAY) {
      bonusButton.disabled = false;
      bonusButton.textContent = 'Ежедневный бонус';
    } else {
      bonusButton.disabled = true;
      bonusButton.textContent = 'Бонус уже получен!';
    }
  };
  checkBonus();

  bonusButton.addEventListener('click', () => {
    if (bonusButton.disabled) return;
    dragoCount += 100;
    saveGameData();
    updateUI();
    localStorage.setItem('lastBonus', new Date().getTime());
    checkBonus();
  });

  drago.addEventListener('click', () => {
    dragoCount += level;
    saveGameData();
    updateUI();
  });

  shopButton.addEventListener('click', () => {
    if (dragoCount >= levelCost * level) {
      dragoCount -= levelCost * level;
      level++;
      saveGameData();
      updateUI();
    } else {
      alert('Недостаточно Drago для улучшения!');
    }
  });

  // Обновленный обработчик для рейтинга
  ratingButton.addEventListener('click', () => {
    const existingPlayer = leaderboard.find((player) => player.name === playerName);
    if (existingPlayer) {
      existingPlayer.score = dragoCount; // Обновляем очки, если игрок уже есть
    } else {
      leaderboard.push({ name: playerName, score: dragoCount }); // Добавляем нового игрока
    }

    leaderboard.sort((a, b) => b.score - a.score); // Сортировка по очкам
    localStorage.setItem('leaderboard', JSON.stringify(leaderboard));

    // Отображение топа игроков
    alert('Рейтинг обновлен! Топ игроков:\n' +
      leaderboard
        .slice(0, 5)
        .map((player, i) => `${i + 1}. ${player.name}: ${player.score} Drago`)
        .join('\n')
    );
  });

  clearDataButton.addEventListener('click', () => {
    if (confirm('Вы уверены, что хотите очистить все данные?')) {
      localStorage.clear();
      alert('Все данные очищены!');
      location.reload();
    }
  });
</script>
