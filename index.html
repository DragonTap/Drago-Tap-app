<script>
  // Переменные
  let dragoCount = parseInt(localStorage.getItem('dragoCount')) || 0; // Загрузка очков
  let level = parseInt(localStorage.getItem('level')) || 1; // Загрузка уровня
  const levelCost = 50;

  // Локальный рейтинг
  let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
  let playerName = localStorage.getItem('playerName') || null;

  // Telegram WebApp API: получение данных профиля
  const tg = window.Telegram.WebApp;
  tg.ready();

  // Если имя не сохранено, запрос через Telegram API
  if (!playerName) {
    if (tg.initDataUnsafe?.user) {
      playerName = tg.initDataUnsafe.user.first_name || 'Игрок';
      localStorage.setItem('playerName', playerName);
      if (tg.initDataUnsafe.user.username === 'ADMIN1') {
        document.getElementById('admin-section').style.display = 'block';
      }
    } else {
      alert('Telegram Web App API недоступен.');
      playerName = 'Игрок';
    }
  } else if (playerName === 'ADMIN1') {
    document.getElementById('admin-section').style.display = 'block';
  }

  // Элементы
  const drago = document.getElementById('drago');
  const counter = document.getElementById('counter');
  const levelDisplay = document.getElementById('level');
  const shopButton = document.getElementById('shop');
  const bonusButton = document.getElementById('bonus-btn');
  const ratingButton = document.getElementById('rating-btn');
  const clearDataButton = document.getElementById('clear-data-btn');

  // Обновление интерфейса
  const updateUI = () => {
    counter.textContent = `Вы заработали: ${dragoCount} Drago`;
    levelDisplay.textContent = `Уровень: ${level}`;
    shopButton.textContent = `Улучшить уровень (Стоимость: ${levelCost * level} Drago)`;
  };

  updateUI(); // Загрузка данных при запуске

  // Сохранение данных
  const saveGameData = () => {
    localStorage.setItem('dragoCount', dragoCount);
    localStorage.setItem('level', level);
  };

  // Счетчик ежедневного бонуса
  const lastBonus = localStorage.getItem('lastBonus') || 0;
  const ONE_DAY = 24 * 60 * 60 * 1000;

  // Проверка бонуса
  const checkBonus = () => {
    const now = new Date().getTime();
    if (now - lastBonus > ONE_DAY) {
      bonusButton.disabled = false;
      bonusButton.textContent = 'Ежедневный бонус';
    } else {
      bonusButton.disabled = true;
      bonusButton.textContent = 'Бонус уже получен!';
    }
  };
  checkBonus();

  // Ежедневный бонус
  bonusButton.addEventListener('click', () => {
    if (bonusButton.disabled) return;
    dragoCount += 100;
    saveGameData(); // Сохранение данных
    updateUI();
    localStorage.setItem('lastBonus', new Date().getTime());
    checkBonus();
  });

  // Клик по дракону
  drago.addEventListener('click', () => {
    dragoCount += level;
    saveGameData(); // Сохранение данных
    updateUI();
  });

  // Покупка уровня
  shopButton.addEventListener('click', () => {
    if (dragoCount >= levelCost * level) {
      dragoCount -= levelCost * level;
      level++;
      saveGameData(); // Сохранение данных
      updateUI();
    } else {
      alert('Недостаточно Drago для улучшения!');
    }
  });

  // Рейтинг игроков
  ratingButton.addEventListener('click', () => {
    leaderboard.push({ name: playerName, score: dragoCount });
    leaderboard.sort((a, b) => b.score - a.score);
    localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
    alert('Рейтинг обновлен! Топ игроков:\n' +
      leaderboard
        .slice(0, 5)
        .map((player, i) => `${i + 1}. ${player.name}: ${player.score} Drago`)
        .join('\n')
    );
  });

  // Очистка данных администратора
  clearDataButton.addEventListener('click', () => {
    if (confirm('Вы уверены, что хотите очистить все данные?')) {
      localStorage.clear();
      alert('Все данные очищены!');
      location.reload();
    }
  });
</script>
